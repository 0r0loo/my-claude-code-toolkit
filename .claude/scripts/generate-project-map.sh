#!/usr/bin/env bash
# generate-project-map.sh - PROJECT_MAP.md를 자동 생성한다
# Usage: .claude/scripts/generate-project-map.sh
# 프로젝트 루트에서 실행하면 .claude/PROJECT_MAP.md를 생성한다.

set -e

# .claude 디렉토리 확인
CLAUDE_DIR=""
if [ -d ".claude" ]; then
  CLAUDE_DIR=".claude"
elif [ -d "$(git rev-parse --show-toplevel 2>/dev/null)/.claude" ]; then
  CLAUDE_DIR="$(git rev-parse --show-toplevel)/.claude"
else
  echo "Error: .claude/ 디렉토리를 찾을 수 없습니다." >&2
  exit 1
fi

OUTPUT_FILE="$CLAUDE_DIR/PROJECT_MAP.md"
TEMP_FILE="$(mktemp)"
trap 'rm -f "$TEMP_FILE"' EXIT

# === JSON 파싱 헬퍼 ===
# python3 사용 가능하면 python3, 아니면 순수 grep/sed 폴백
json_get() {
  local file="$1"
  local key="$2"
  if command -v python3 &>/dev/null; then
    python3 -c "
import json, sys
try:
    d = json.load(open('$file'))
    val = d.get('$key', '')
    if isinstance(val, str):
        print(val)
    elif isinstance(val, dict):
        for k in val:
            print(k)
    elif isinstance(val, list):
        for item in val:
            print(item)
except:
    pass
" 2>/dev/null
  else
    grep -o "\"$key\"[[:space:]]*:[[:space:]]*\"[^\"]*\"" "$file" 2>/dev/null | head -1 | sed 's/.*: *"\(.*\)"/\1/'
  fi
}

json_get_scripts() {
  local file="$1"
  if command -v python3 &>/dev/null; then
    python3 -c "
import json, sys
try:
    d = json.load(open('$file'))
    scripts = d.get('scripts', {})
    for key in ['dev', 'build', 'test', 'start', 'lint']:
        if key in scripts:
            print(f'{key}: {scripts[key]}')
except:
    pass
" 2>/dev/null
  fi
}

json_get_deps() {
  local file="$1"
  if command -v python3 &>/dev/null; then
    python3 -c "
import json, sys
try:
    d = json.load(open('$file'))
    deps = {}
    deps.update(d.get('dependencies', {}))
    deps.update(d.get('devDependencies', {}))
    # 주요 프레임워크/라이브러리만 추출
    keywords = [
        'react', 'next', 'vue', 'nuxt', 'angular', 'svelte',
        'nest', 'express', 'fastify', 'koa', 'hono',
        'typeorm', 'prisma', 'drizzle', 'mongoose', 'sequelize',
        'tailwind', 'styled-components', 'emotion',
        'jest', 'vitest', 'mocha', 'cypress', 'playwright',
        'typescript', 'webpack', 'vite', 'turbo', 'esbuild',
        'zustand', 'redux', 'recoil', 'jotai', 'mobx',
        'tanstack', 'react-query', 'swr', 'axios',
        'zod', 'yup', 'joi', 'class-validator',
        'react-hook-form', 'formik',
        'storybook', 'eslint', 'prettier',
    ]
    found = []
    for dep, ver in sorted(deps.items()):
        dep_lower = dep.lower()
        for kw in keywords:
            if kw in dep_lower:
                found.append(f'{dep}@{ver}')
                break
    for item in found:
        print(item)
except:
    pass
" 2>/dev/null
  fi
}

# === 생성 시작 ===
{
  echo "# PROJECT MAP"
  echo ""
  echo "> Auto-generated by \`generate-project-map.sh\`"
  echo "> 이 파일은 explore 에이전트의 사전 캐시로 사용된다. 직접 수정하지 말 것."
  echo ""

  # --- 프로젝트 정보 ---
  echo "## 프로젝트 정보"
  echo ""

  if [ -f "package.json" ]; then
    local_name="$(json_get package.json name)"
    if [ -n "$local_name" ]; then
      echo "- **이름**: $local_name"
    fi
  fi

  if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
    echo "- **브랜치**: $(git branch --show-current 2>/dev/null || echo 'unknown')"
    echo "- **최근 커밋**: $(git log -1 --format='%h %s' 2>/dev/null || echo 'unknown')"
  fi

  echo "- **생성 시간**: $(date '+%Y-%m-%d %H:%M:%S')"

  # 총 파일 수 (소스 파일만)
  total_files=0
  if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
    total_files=$(git ls-files 2>/dev/null | wc -l | tr -d ' ')
  else
    total_files=$(find . -type f \
      -not -path '*/node_modules/*' \
      -not -path '*/.git/*' \
      -not -path '*/.next/*' \
      -not -path '*/dist/*' \
      -not -path '*/build/*' \
      -not -path '*/coverage/*' \
      2>/dev/null | wc -l | tr -d ' ')
  fi
  echo "- **총 파일 수**: $total_files"
  echo ""

  # --- 기술 스택 ---
  if [ -f "package.json" ]; then
    deps="$(json_get_deps package.json)"
    if [ -n "$deps" ]; then
      echo "## 기술 스택"
      echo ""
      echo '```'
      echo "$deps"
      echo '```'
      echo ""
    fi
  fi

  # --- 디렉토리 구조 ---
  echo "## 디렉토리 구조"
  echo ""
  echo '```'

  EXCLUDE_DIRS="node_modules|.git|.next|dist|build|coverage|.cache|.turbo|__pycache__|.venv|vendor"

  find_dirs() {
    find . -maxdepth 3 -type d \
      \( -name node_modules -o -name .git -o -name .next -o -name dist \
         -o -name build -o -name coverage -o -name .cache -o -name .turbo \
         -o -name __pycache__ -o -name .venv -o -name vendor \
         -o -name .idea -o -name .vscode \) -prune \
      -o -type d -print 2>/dev/null | sort | head -80
  }

  if command -v tree &>/dev/null; then
    tree -d -L 3 -I "$EXCLUDE_DIRS|.idea|.vscode" --noreport 2>/dev/null || find_dirs
  else
    find_dirs
  fi

  echo '```'
  echo ""

  # --- 주요 파일 ---
  echo "## 주요 파일"
  echo ""

  # 설정 파일
  config_files=""
  for f in package.json tsconfig.json tsconfig.*.json \
           .eslintrc* eslint.config.* .prettierrc* prettier.config.* \
           next.config.* vite.config.* webpack.config.* \
           nest-cli.json ormconfig.* \
           docker-compose.yml Dockerfile \
           .env.example .env.local.example; do
    # glob 확장이 파일과 매치하는지 확인
    for match in $f; do
      if [ -f "$match" ]; then
        config_files="$config_files$match\n"
      fi
    done
  done

  if [ -n "$config_files" ]; then
    echo "### 설정 파일"
    echo ""
    printf '%b' "$config_files" | sort -u | while read -r cf; do
      [ -n "$cf" ] && echo "- \`$cf\`"
    done
    echo ""
  fi

  # 엔트리포인트
  entry_files=""
  for f in src/main.ts src/main.tsx src/index.ts src/index.tsx \
           src/app.ts src/app.tsx src/App.tsx \
           app/layout.tsx app/page.tsx \
           src/app/layout.tsx src/app/page.tsx \
           pages/_app.tsx pages/index.tsx \
           src/pages/_app.tsx src/pages/index.tsx; do
    if [ -f "$f" ]; then
      entry_files="$entry_files$f\n"
    fi
  done

  if [ -n "$entry_files" ]; then
    echo "### 엔트리포인트"
    echo ""
    printf '%b' "$entry_files" | while read -r ef; do
      [ -n "$ef" ] && echo "- \`$ef\`"
    done
    echo ""
  fi

  # --- 빌드 명령 ---
  if [ -f "package.json" ]; then
    scripts="$(json_get_scripts package.json)"
    if [ -n "$scripts" ]; then
      echo "## 빌드 명령"
      echo ""
      echo '```'
      echo "$scripts"
      echo '```'
      echo ""
    fi
  fi

} > "$TEMP_FILE"

# 파일 크기 확인 (20KB 제한)
file_size=$(wc -c < "$TEMP_FILE" | tr -d ' ')
if [ "$file_size" -gt 20480 ]; then
  echo "Warning: PROJECT_MAP.md가 20KB를 초과합니다 (${file_size}B). 잘라냅니다." >&2
  head -c 20480 "$TEMP_FILE" > "$OUTPUT_FILE"
  echo "" >> "$OUTPUT_FILE"
  echo "> [truncated - 20KB 제한 초과]" >> "$OUTPUT_FILE"
else
  cp "$TEMP_FILE" "$OUTPUT_FILE"
fi

echo "PROJECT_MAP.md 생성 완료: $OUTPUT_FILE (${file_size}B)"